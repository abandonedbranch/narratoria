## Rules

RULE: All implementations MUST comply with [CONTRIB.md](CONTRIB.md).

RULE: Audience
- All documents in this repository EXCEPT `README` are written for GPT-5.x models only.
- Optimize for deterministic regeneration of the system in a blank workspace.

RULE: Spec-first authority
- Specs are the authoritative implementation definition.
- Code is a derived byproduct.
- When spec and code conflict, the spec wins (until the spec is updated).

RULE: Style (machine-oriented)
- Prefer normative, testable wording: MUST / SHOULD / MAY.
- Prefer explicit types, inputs/outputs, invariants, failure modes, cancellation semantics, and observability fields.
- Avoid human-oriented narrative or pedagogy.

## Spec Directory

- All specs live in `specs/`.
- Template: `specs/_template.spec.md`.
- RULE: Before creating a new spec file, the coding agent MUST read `specs/_template.spec.md` and follow its structure verbatim (headings/sections), only replacing placeholders.
- Completed specs:
  - `specs/indexeddb-storage-service.spec.md`
  - `specs/storage-quota-awareness-service.spec.md`
  - `specs/openai-api-service.spec.md`
  - `specs/narrator-pipeline-service.spec.md`
  - `specs/narration-persistence-middleware.spec.md`
  - `specs/narration-provider-dispatch-middleware.spec.md`
  - `specs/narration-content-guardian-middleware.spec.md`
  - `specs/narration-system-prompt-middleware.spec.md`
  - `specs/narration-attachment-ingestion-service.spec.md`
  - `specs/narration-pipeline-log-ui.spec.md`
  - `specs/system-prompt-profile-resolver.spec.md`
  - `specs/prompt-input-bar-ui.spec.md`
  - `specs/attachments-dropzone-ui.spec.md`
  - `specs/narration-session-orchestrator-ui.spec.md`
  - `specs/pipeline-observer-view-adapter.spec.md`
  - `specs/stage-metadata-provider.spec.md`
- If any spec is not yet complete, add it under a "Not completed" list with owner and expected completion date.
- Implementors must explicitly state what is complete and what remains when updating this file.
- IMPORTANT: After any work on a spec/implementation pair (including drift reduction), update this file with an explicit status note. Listing a spec as “Completed” is not sufficient unless “what remains” is explicitly “none”.

## Status Reporting (Required)

When you touch a spec or its implementation, you must also update this file with a brief status note.

Minimum required update (pick one):
- Add/refresh the “What remains” section (even if the answer is “none”).
- Or, if the work is partial, move the spec under a “Not completed” list with an owner.

The goal is to keep this file truthful about drift and remaining work, not just about whether a spec document exists.

RULE: Drift tracking
- The “What remains” section MUST track BOTH:
  - current drift (known mismatches between specs and code)
  - potential drift (high-risk areas where drift is likely or expected soon)
- Each bullet SHOULD name the affected spec/component and the nature of the drift.
- If drift is fully resolved for a component, explicitly state “none” for that component (do not omit).

## What remains

- Provider dispatch (current drift): metrics/log fields not fully aligned with spec; verify terminal/stream-composition semantics remain consistent with the streaming contract.
- IndexedDB storage (current drift): CRUD surface incomplete (e.g., no Get/Delete); observability field completeness varies by operation.
 - Narration pipeline log UI (current drift): render-only component implemented; hover metadata popovers now present via chip title; auto-scroll remains unimplemented; expand Playwright coverage to assert hover content deterministically.
 - Prompt input bar UI (current drift): component implemented with gating and error banner; E2E SHOULD validate cancellation propagation; no implicit retries enforced.
 - Attachments dropzone UI (current drift): component implemented; ingestion middleware NOT yet wired into orchestrator; drag-and-drop interactions MAY be added; Playwright covers acceptance via payload.
 - Narration session orchestrator UI (current drift): component implemented and wired with observer→view adapter and stage metadata provider; restore-from-store remains unimplemented; demo provider remains in orchestrator for local streaming only.
 - Pipeline observer→view adapter (current drift): implemented and integrated; monitor for event mismatches; add unit tests for skipped/failure transitions coverage breadth.
 - Stage metadata provider (current drift): implemented and integrated; provider metrics (tokens/model) emitted via middleware; prompt token estimation remains unimplemented.
 - System prompt profile resolver (current drift): config-backed resolver implemented with success/not_found/error/cancelled metrics and logs; storage-backed or policy-based selection remains unimplemented.
 - System prompt profile resolver (potential drift): future changes to selection policies MUST remain deterministic and versioned; any caching MUST preserve consistency across a single process lifetime.
- Provider dispatch (potential drift): future middleware additions that wrap streams must preserve early-dispose cancellation propagation upstream.
- Persistence (potential drift): any future changes must preserve “skip persistence on downstream failure” and must not reintroduce persistence of per-run prompt state.

## Not completed
 
 - Restore-from-store in orchestrator — Owner: GitHub Copilot — Expected completion: 2025-12-20.
 - Attachment ingestion wiring in orchestrator — Owner: GitHub Copilot — Expected completion: 2025-12-21.
 - Prompt token estimation and emission — Owner: GitHub Copilot — Expected completion: 2025-12-21.

## Format

Mode
Behavior (WHAT / INPUT / OUTPUT / FAILS / NEVER)
Policies
Invariants
Observability
Never
Non-goals
Output

## Clarifications

- Mode: `isolated` (pure function, no shared state), `compositional` (cooperates with collaborators), `stateful` (reads/writes owned state).
- Behavior: spell out caller obligations (auth/session/state loading), allowed side effects, and typed inputs/outputs referencing existing DTOs/interfaces when possible.
- Policies: include retry/timeout/idempotency/concurrency/cancellation requirements; async methods accept `CancellationToken`.
- Invariants: note determinism, thread-safety, and constraints that must be true for all executions.
- Observability: define required log/event fields (e.g., `trace_id`, `request_id`, `stage`, `elapsed_ms`, `status`, `error_class`) and when they emit.
- Never/Non-goals: list forbidden behaviors and explicitly excluded scope to prevent drift.
- Output: minimal implementation only—no commentary, no TODOs.

## Defaults

Mode: Isolated behavior
Output: Minimal implementation only. No commentary.

## Checklist

- Mode selected and justified.
- Inputs/outputs typed and reference known types.
- Failure modes are structured with required side effects.
- Policies cover retry/timeout/idempotency/concurrency/cancellation.
- Invariants and observability are testable and log fields are defined.
- Never/Non-goals prevent unwanted side effects.
- Spec is added to `specs/` and linked above.
