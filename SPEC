## Rules

- Specs MUST reference and defer all coding standards to [CONTRIB.md](CONTRIB.md). Do not restate coding rules here.

- Audience (spec documents only)
  - All documents EXCEPT `README` target GPT-5.x models.
  - Optimize for deterministic regeneration in a blank workspace.

- Spec-first authority (for specification workflow)
  - Specs define behavior; code is derived.
  - When spec and code conflict, the spec wins until the spec is updated.

- Spec style (machine-oriented authoring)
  - Use normative wording: MUST / SHOULD / MAY.
  - Define explicit types, inputs/outputs, invariants, failure modes, cancellation semantics, observability fields.
  - Avoid human-oriented narrative/pedagogy.

## Spec Directory

- All specs live in `specs/`.
- Template: `specs/_template.spec.md`.
- RULE: Before creating a new spec file, the coding agent MUST read `specs/_template.spec.md` and follow its structure verbatim (headings/sections), only replacing placeholders.
- RULE: The list below MUST mirror the filenames present in the `specs/` directory. Keep it up to date whenever files are added, removed, or renamed.

### Specs Index (mirrors specs/)

- `specs/_template.spec.md`
- `specs/11-attachments-dropzone-ui.spec.md`
- `specs/06-attachment-context-injection-middleware.spec.md`
- `specs/13-compose-bar-ui.spec.md`
- `specs/indexeddb-storage-service.spec.md`
- `specs/05-narration-attachment-ingestion-service.spec.md`
- `specs/narration-content-guardian-middleware.spec.md`
- `specs/narration-persistence-middleware.spec.md`
- `specs/07-narration-pipeline-factory.spec.md`
- `specs/08-narration-pipeline-integration.spec.md`
- `specs/09-narration-pipeline-log-ui.spec.md`
- `specs/narration-provider-dispatch-middleware.spec.md`
- `specs/14-narration-session-orchestrator-ui.spec.md`
- `specs/narration-system-prompt-middleware.spec.md`
- `specs/narrator-pipeline-service.spec.md`
- `specs/openai-api-service.spec.md`
- `specs/10-pipeline-observer-view-adapter.spec.md`
- `specs/12-prompt-input-bar-ui.spec.md`
- `specs/03-stage-event-contract.spec.md`
- `specs/04-stage-pipeline.spec.md`
- `specs/stage-metadata-provider.spec.md`
- `specs/storage-quota-awareness-service.spec.md`
- `specs/system-prompt-profile-resolver.spec.md`
- `specs/16-workspace-shell-ui.spec.md`
- `specs/01-narration-session-store.spec.md`
- `specs/15-narration-session-list-ui.spec.md`
- `specs/17-narration-session-title-middleware.spec.md`
- `specs/02-narration-processed-attachment-store.spec.md`

RULE: Specification status tracking
- The "What remains" section tracks specification work that is pending or incomplete.
- This includes: specs not yet written, specs requiring updates, or areas needing clearer specification.
- For implementation drift, functionality gaps, and technical debt, see TODO at the repo root (per CONTRIB).

## Format (Template Sections)

- Mode
- Behavior (WHAT / INPUT / OUTPUT / FAILS / NEVER)
- Policies
- Invariants
- Observability
- Never
- Non-goals
- Output

## Clarifications (Spec Authoring)

- Mode: `isolated` (pure function, no shared state), `compositional` (cooperates with collaborators), `stateful` (reads/writes owned state).
- Behavior: caller obligations, allowed side effects, typed inputs/outputs referencing existing DTOs/interfaces.
- Policies: retry/timeout/idempotency/concurrency/cancellation; async methods accept `CancellationToken`.
- Invariants: determinism, thread-safety, constraints.
- Observability: required log/event fields (e.g., `trace_id`, `request_id`, `stage`, `elapsed_ms`, `status`, `error_class`) and emit timing.
- Never/Non-goals: forbidden behaviors and excluded scope to prevent drift.
- Output: minimal implementation onlyâ€”no commentary, no TODOs.

## Defaults

- Mode: Isolated behavior
- Output: Minimal implementation only. No commentary.

## Cross-refs

- Coding standards, interfaces, testing practices, and implementation rules live in [CONTRIB.md](CONTRIB.md).
- This SPEC governs specification authoring, specification status tracking, and spec-first authority only.
- Implementation drift, functionality gaps, and technical debt tracking live in [TODO](TODO).

## Checklist

- Mode selected and justified.
- Inputs/outputs typed and reference known types.
- Failure modes are structured with required side effects.
- Policies cover retry/timeout/idempotency/concurrency/cancellation.
- Invariants and observability are testable and log fields are defined.
- Never/Non-goals prevent unwanted side effects.
- Spec is added to `specs/` and linked above.
