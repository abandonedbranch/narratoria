# TODO

Purpose
- Track spec drift, functionality gaps (spec-defined or not), and technical debt.
- Update this file before finishing work when items still remain.

## Spec Drift

- Provider dispatch: metrics/log fields not fully aligned with spec; verify terminal/stream-composition semantics remain consistent with the streaming contract.
- IndexedDB storage: CRUD surface incomplete (e.g., no Get/Delete); observability field completeness varies by operation.
- Narration pipeline log UI: render-only component implemented; hover metadata popovers present via chip title; auto-scroll remains unimplemented; expand Playwright coverage to assert hover content deterministically.
- Prompt input bar UI: component implemented with gating and error banner; E2E SHOULD validate cancellation propagation; no implicit retries enforced.
- Attachments dropzone UI: component implemented; ingestion middleware NOT yet wired into orchestrator; drag-and-drop interactions MAY be added; Playwright covers acceptance via payload.
- Narration session orchestrator UI: component implemented and wired with observer→view adapter and stage metadata provider; restore-from-store remains unimplemented; demo provider remains in orchestrator for local streaming only.
- Pipeline observer→view adapter: implemented and integrated; monitor for event mismatches; add unit tests for skipped/failure transitions coverage breadth.
- Stage metadata provider: implemented and integrated; provider metrics (tokens/model) emitted via middleware; prompt token estimation remains unimplemented.

- Pipeline integration (current drift): telemetry and stage-metadata are keyed by SessionId in middleware, while the log UI hover lookup is keyed by TurnId; integration requires turn-scoped observer and stage-metadata wrappers or adding TurnId to telemetry.
- Pipeline composition (current drift): Program registers a singleton NarrationPipelineService, but per-submission attachment ingestion requires a DI pipeline factory that can compose a submission-specific chain.
- Attachments upload-store (current drift): dropzone currently emits metadata only; attachment ingestion requires raw bytes to be written to IAttachmentUploadStore prior to ingestion.
- Stage naming (current drift): middleware stage ids (e.g., provider_dispatch/session_load/persist_context/attachment_ingestion) do not align with default StageOrder kinds (Sanitize/Context/Lore/Llm); mapping must be specified and deterministic.
- Attachments MIME policy (current drift): ingestion options allow application/pdf in code, but ingestion decodes as UTF-8 text; either disallow PDF or implement extraction and align specs.
- Attachment ingestion observability (current drift): AttachmentIngestionMiddleware throws on failure but does not emit observer stage telemetry; failure-to-chip transitions must be specified and implemented.
- System prompt profile resolver (current drift): config-backed resolver implemented with success/not_found/error/cancelled metrics and logs; storage-backed or policy-based selection remains unimplemented.
- System prompt profile resolver (potential drift): future changes to selection policies MUST remain deterministic and versioned; any caching MUST preserve consistency across a single process lifetime.
- Provider dispatch (potential drift): future middleware additions that wrap streams must preserve early-dispose cancellation propagation upstream.
- Persistence (potential drift): any future changes must preserve “skip persistence on downstream failure” and must not reintroduce persistence of per-run prompt state.

## Functionality Gaps

- Restore-from-store in orchestrator: not implemented.
- Attachment ingestion wiring in orchestrator: not implemented.
- Prompt token estimation and emission: not implemented.

- DI pipeline factory: not implemented (required for per-submission middleware insertion without fallback pipelines).
- Attachment upload store write path: not implemented (required before attachment ingestion can succeed).
- Turn-scoped observer/stage-metadata mapping: not implemented (required for hover metadata to match log lookup).

## Technical Debt

- Broaden Playwright coverage: hover content determinism across multiple stages; cancellation propagation for prompt bar.
- IndexedDB observability: normalize required fields per operation; complete CRUD (Get/Delete).
- Log UI auto-scroll: implement if added to spec; otherwise defer.
- Ensure consistent cancellation normalization across middleware.
