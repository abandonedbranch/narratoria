{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://narratoria.dev/schemas/execution-result.schema.json",
  "title": "Plan Execution Result",
  "description": "Canonical schema for plan executor output. Used for replan feedback loop, debugging, and narrator AI decisions.",
  "type": "object",
  "required": ["planId", "success", "failedTools", "executionTrace"],
  "properties": {
    "planId": {
      "type": "string",
      "format": "uuid",
      "description": "UUID of the executed plan (matches plan.requestId)",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
    },
    "success": {
      "type": "boolean",
      "description": "Whether plan execution succeeded overall (all required tools completed)"
    },
    "narrative": {
      "type": "string",
      "description": "Final narrative text to display to player (optional, may be populated from tool outputs)"
    },
    "failedTools": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "List of tool IDs that failed during execution"
    },
    "canReplan": {
      "type": "boolean",
      "description": "Whether failures are recoverable via replan (true if temporary/degraded, false if permanent)"
    },
    "failureReason": {
      "type": "string",
      "description": "Why the plan failed (if applicable)",
      "enum": ["circular_dependency", "tool_failure", "timeout", "protocol_violation"]
    },
    "executionTrace": {
      "type": "array",
      "description": "Chronological log of tool executions with full details",
      "items": {
        "type": "object",
        "required": ["toolId", "state", "executionTimeMs", "retryCount"],
        "properties": {
          "toolId": {
            "type": "string",
            "description": "Tool identifier from Plan JSON"
          },
          "toolPath": {
            "type": "string",
            "description": "Skill script path"
          },
          "ok": {
            "type": "boolean",
            "description": "Logical success from done.ok event"
          },
          "state": {
            "type": "string",
            "enum": ["pending", "running", "completed", "failed", "skipped", "timeout"],
            "description": "Final execution state"
          },
          "output": {
            "description": "Tool output (from done event or aggregated state patches)"
          },
          "events": {
            "type": "array",
            "description": "All NDJSON events emitted by tool (log, state_patch, asset, ui_event, error, done)",
            "items": {
              "type": "object",
              "required": ["version", "type"],
              "properties": {
                "version": {
                  "type": "string"
                },
                "type": {
                  "type": "string",
                  "enum": ["log", "state_patch", "asset", "ui_event", "error", "done"]
                }
              }
            }
          },
          "executionTimeMs": {
            "type": "integer",
            "minimum": 0,
            "description": "Tool execution time in milliseconds"
          },
          "retryCount": {
            "type": "integer",
            "minimum": 0,
            "description": "Number of retry attempts before success/failure"
          },
          "error": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "description": "Error classification (ToolExecutionFailed, DependencyFailed, Timeout, ProtocolViolation)"
              },
              "message": {
                "type": "string",
                "description": "Human-readable error message"
              },
              "exitCode": {
                "type": "integer",
                "description": "Process exit code (if applicable)"
              }
            },
            "description": "Error details if tool failed"
          }
        }
      }
    },
    "finalState": {
      "type": "object",
      "description": "Aggregated session state after all state_patch events applied"
    },
    "totalExecutionTimeMs": {
      "type": "integer",
      "minimum": 0,
      "description": "Total time from plan submission to completion"
    },
    "generationMetadata": {
      "type": "object",
      "description": "Metadata from the executed plan (passed through for replan context)",
      "properties": {
        "generationAttempt": {
          "type": "integer",
          "minimum": 1,
          "description": "Which plan generation attempt this was"
        },
        "parentPlanId": {
          "type": ["string", "null"],
          "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$",
          "description": "UUID of parent plan if this was a replan"
        }
      }
    }
  }
}
