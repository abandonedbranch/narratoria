{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://narratoria.dev/schemas/execution-result.schema.json",
  "title": "Plan Execution Result",
  "description": "Schema for plan executor output returned to narrator AI for replan decisions",
  "type": "object",
  "required": ["planId", "success", "failedTools", "executionTrace"],
  "properties": {
    "planId": {
      "type": "string",
      "format": "uuid",
      "description": "UUID of the executed plan"
    },
    "success": {
      "type": "boolean",
      "description": "Whether plan execution succeeded overall"
    },
    "failedTools": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "List of tool IDs that failed during execution"
    },
    "canReplan": {
      "type": "boolean",
      "description": "Whether failures are recoverable via replan (true if temporary/degraded, false if permanent)"
    },
    "executionTrace": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["toolId", "state", "executionTimeMs", "retryCount"],
        "properties": {
          "toolId": {
            "type": "string",
            "description": "Tool identifier from Plan JSON"
          },
          "toolPath": {
            "type": "string",
            "description": "Skill script path"
          },
          "state": {
            "type": "string",
            "enum": ["pending", "running", "completed", "failed", "skipped", "timeout"],
            "description": "Final execution state"
          },
          "output": {
            "description": "Tool output (from done event)"
          },
          "events": {
            "type": "array",
            "description": "All NDJSON events emitted by tool (log, state_patch, asset, ui_event, error, done)"
          },
          "executionTimeMs": {
            "type": "integer",
            "minimum": 0,
            "description": "Total execution time in milliseconds"
          },
          "retryCount": {
            "type": "integer",
            "minimum": 0,
            "description": "Number of retry attempts before success/failure"
          },
          "error": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "description": "Error classification (ToolExecutionFailed, DependencyFailed, Timeout, etc.)"
              },
              "message": {
                "type": "string",
                "description": "Human-readable error message"
              },
              "exitCode": {
                "type": "integer",
                "description": "Process exit code (if applicable)"
              }
            },
            "description": "Error details if tool failed"
          }
        }
      },
      "description": "Chronological log of tool executions with full details"
    },
    "finalState": {
      "type": "object",
      "description": "Aggregated session state after all state_patch events applied"
    },
    "totalExecutionTimeMs": {
      "type": "integer",
      "minimum": 0,
      "description": "Total time from plan submission to completion"
    }
  }
}
