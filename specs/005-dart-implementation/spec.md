# Specification 005: Dart/Flutter Implementation and UX

> **Status**: Draft
> **Version**: 0.1.0
> **Parent Specs**: [001-tool-protocol](../001-tool-protocol-spec/spec.md), [002-plan-execution](../002-plan-execution/spec.md), [003-skills-framework](../003-skills-framework/spec.md), [004-narratoria-skills](../004-narratoria-skills/spec.md)

## RFC 2119 Keywords

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in [RFC 2119](https://datatracker.ietf.org/doc/html/rfc2119).

## 1. Purpose

This specification defines the Dart+Flutter reference implementation of the Narratoria platform, implementing the contracts defined in Spec 001 (Tool Protocol), execution semantics from Spec 002 (Plan Execution), skill framework from Spec 003 (Skills Framework), and individual skills from Spec 004 (Narratoria Skills).

**Scope includes:**
- Flutter UI implementation with Material Design 3
- Dart class implementations of protocol entities and architectural components
- MVP feature requirements
- Project structure and file organization
- Implementation guidance and best practices

**Scope excludes:**
- Protocol definitions (see Spec 001)
- Plan execution algorithms (see Spec 002)
- Skill discovery and configuration framework (see Spec 003)
- Individual skill specifications (see Spec 004)
- Language-agnostic contracts and schemas

---

## 2. Flutter UI Requirements

> Content extracted from Spec 001 Â§12

### 2.1 Design System

Narratoria MUST use **Material Design 3** for its Flutter UI. This provides:
- First-class Flutter support with extensive widget library
- Cross-platform consistency (macOS, Windows, Linux)
- Excellent testability via `flutter_test`
- Mature theming and customization

### 2.2 Core UI Components

The Narratoria client MUST implement these components:

#### Tool Execution Panel
Displays active tool invocations with real-time progress:
- Tool name and current status
- Streaming log output (from `log` events)
- Progress indicators for long-running operations
- Error display (from `error` events)
- Completion status (from `done` events)

#### Asset Gallery
Displays assets generated by tools (from `asset` events):
- Image preview with metadata
- Audio player controls
- Video player controls
- **Graceful degradation**: Placeholder cards for unsupported `mediaType` values showing asset details

#### Narrative State Panel
Displays current session state:
- Expandable tree view of state objects
- State changes highlighted (from `state_patch` events)
- JSON inspector for debugging

#### Player Choice Interface
Displays AI-generated choices for player selection:
- 3-5 choice buttons arranged vertically
- Each choice shows descriptive text
- Active/hover states for selection feedback
- Disabled state during scene generation
- **Note**: Players select from presented choices only; free-text input is not supported per Spec 008 FR-017

### 2.3 UI Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NavigationRail   â”‚   Main Content Area     â”‚
â”‚                   â”‚                         â”‚
â”‚  â€¢ Narrative      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â€¢ Tools          â”‚  â”‚  Story View      â”‚  â”‚
â”‚  â€¢ Assets         â”‚  â”‚  (narrative text â”‚  â”‚
â”‚  â€¢ State          â”‚  â”‚   + assets)      â”‚  â”‚
â”‚                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                   â”‚                         â”‚
â”‚                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                   â”‚  â”‚  Player Choices  â”‚  â”‚
â”‚                   â”‚  â”‚  [choice 1]      â”‚  â”‚
â”‚                   â”‚  â”‚  [choice 2]      â”‚  â”‚
â”‚                   â”‚  â”‚  [choice 3]      â”‚  â”‚
â”‚                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 Theming

The client MUST implement a dark-themed Material Design 3 scheme suitable for immersive storytelling:

```dart
ThemeData(
  useMaterial3: true,
  colorScheme: ColorScheme.fromSeed(
    seedColor: Colors.deepPurple,
    brightness: Brightness.dark,
  ),
  typography: Typography.material2021(),
)
```

---

## 3. MVP Requirements

> Content extracted from Spec 001 Â§14

To deliver a minimum viable product that demonstrates the protocol and player interaction flow, the Narratoria client MUST implement:

### 3.1 Core Features (MUST)

1. **Player Choice Selection**: UI displays 3-5 AI-generated choice buttons for player selection (no free-text input per Spec 008 FR-017)
2. **Narrator AI Stub**: In-process Dart service that converts selected choices into Plan JSON (see Â§3.4 for implementation details)
3. **Tool Invocation**: Execute tools per Plan JSON using process launch and stdin/stdout pipes
4. **Event Processing**: Parse NDJSON from tool stdout and dispatch to handlers
5. **UI Event Support**: Implement `narrative_choice` handler (display choice buttons; other events degrade gracefully)
6. **State Management**: Maintain session state, apply `state_patch` events using deep merge
7. **Asset Registry**: Store asset metadata from `asset` events
8. **UI Panels**:
   - Story View (narrative text + rendered assets)
   - Tool Execution Panel (logs, progress)
   - Asset Gallery (images, audio, video with graceful degradation)
   - Narrative State Panel (JSON inspector)   - Player Choice Interface (3-5 choice buttons, no free-text input)
### 3.2 Skill Implementation

For MVP validation, implement the core skills defined in [Spec 004](../004-narratoria-skills/spec.md):

1. **storyteller**: Rich narrative enhancement using LLM
2. **dice-roller**: Randomness and game mechanics
3. **memory**: Semantic memory and continuity
4. **reputation**: Faction standing tracking

Each skill follows the Agent Skills Standard defined in [Spec 003](../003-skills-framework/spec.md) with:
- `skill.json` manifest file
- `config-schema.json` for user configuration
- `prompt.md` for behavioral prompts
- Dart script(s) implementing the skill logic

### 3.3 Sample Plan JSON

For Plan JSON structure and execution semantics, see [Spec 002](../002-plan-execution/spec.md).

Example plan demonstrating sequential execution with dependency tracking:

```json
{
  "requestId": "550e8400-e29b-41d4-a716-446655440000",
  "narrative": "You prepare for your next move.",
  "tools": [
    {
      "toolId": "roll1",
      "toolPath": "skills/dice-roller/roll-dice.dart",
      "input": {"formula": "1d20+5"},
      "dependencies": [],
      "required": true,
      "async": false,
      "retryPolicy": {"maxRetries": 3, "backoffMs": 100}
    },
    {
      "toolId": "narrate1",
      "toolPath": "skills/storyteller/narrate.dart",
      "input": {"context": "player_action_result"},
      "dependencies": ["roll1"],
      "required": true,
      "async": false,
      "retryPolicy": {"maxRetries": 3, "backoffMs": 100}
    }
  ],
  "parallel": false,
  "disabledSkills": [],
  "metadata": {
    "generationAttempt": 1,
    "parentPlanId": null
  }
}
```

This demonstrates sequential execution with dependency tracking and retry policies. For full Plan JSON schema, see [Spec 002 contracts](../002-plan-execution/contracts/plan-json.schema.json).

### 3.4 Narrator AI Stub Implementation

The MVP Narrator AI Stub is an in-process Dart service that provides plan generation without requiring an actual LLM. This enables development and testing of the full pipeline before LLM integration.

**Interface:**

```dart
abstract class NarratorAI {
  /// Generate a Plan JSON from player input
  Future<PlanJson> generatePlan({
    required String playerInput,
    required Set<String> disabledSkills,
    required List<Skill> availableSkills,
    String? parentPlanId,
    int generationAttempt = 1,
  });
}
```

**MVP Stub Implementation:**

```dart
class NarratorAIStub implements NarratorAI {
  /// Hard-coded choice pattern â†’ plan mappings for MVP
  final Map<RegExp, PlanJson Function(String, int)> _mappings = {
    RegExp(r'roll.*dice?', caseSensitive: false): _rollDicePlan,
    RegExp(r'check.*reputation', caseSensitive: false): _reputationPlan,
    RegExp(r'recall|remember', caseSensitive: false): _memoryPlan,
  };

  @override
  Future<PlanJson> generatePlan({...}) async {
    // Check disabled skills and filter mappings
    // Match against patterns
    // Return matching plan or fallback narrative
  }
}
```

**Requirements:**
- MUST implement the `NarratorAI` interface to allow seamless replacement with LLM-backed implementation
- MUST respect `disabledSkills` parameter and avoid selecting disabled tools
- MUST track `generationAttempt` and `parentPlanId` in returned Plan JSON metadata
- MUST return a valid Plan JSON for recognized choice patterns
- MUST return a fallback plan with narrative-only response for unrecognized choices
- SHOULD support at least 5 choice patterns for MVP testing

**Fallback Plan:**

When no pattern matches, return a narrative-only plan:

```json
{
  "requestId": "<uuid>",
  "narrative": "Your choice leads to unexpected consequences...",
  "tools": [],
  "parallel": false,
  "disabledSkills": [],
  "metadata": {"generationAttempt": 1, "parentPlanId": null}
}
```

### 3.5 Error Recovery UI Patterns

The Narratoria UI MUST handle errors gracefully per Constitution Principle IV. This section defines the error display patterns.

#### 3.5.1 Error Display Hierarchy

| Error Source | Display Location | User Action |
|--------------|------------------|-------------|
| Tool failure (`done.ok=false`) | Tool Execution Panel + inline Story View notice | Retry or continue |
| Plan generation failure | Story View with fallback narrative | Select different choice |
| Network/API error | Toast notification + Tool Panel detail | Check connection, retry |
| Protocol violation | Developer console only | None (internal error) |
| Max replan exceeded | Modal dialog with options | Restart session or continue with fallback |

#### 3.5.2 Error UI Components

**Inline Error Notice (Story View):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸ The torch-lighter skill failed.  â”‚
â”‚ The story continues without it...   â”‚
â”‚                                     â”‚
â”‚ [Show Details] [Retry] [Dismiss]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tool Execution Panel Error State:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ”´ torch-lighter         FAILED    â”‚
â”‚    Error: TOOL_TIMEOUT             â”‚
â”‚    "Tool exceeded 30s timeout"     â”‚
â”‚    Retries: 3/3                    â”‚
â”‚    [View Logs] [Copy Error]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Max Replan Modal:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸ Story Generation Issue          â”‚
â”‚                                     â”‚
â”‚  The narrator couldn't complete     â”‚
â”‚  your request after 5 attempts.     â”‚
â”‚                                     â”‚
â”‚  What would you like to do?         â”‚
â”‚                                     â”‚
â”‚  [Continue with Fallback]           â”‚
â”‚  [Restart Session]                  â”‚
â”‚  [View Error Details]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.5.3 Error Recovery Requirements

- MUST display user-friendly error messages (no raw stack traces)
- MUST offer actionable recovery options (retry, continue, restart)
- MUST preserve narrative continuity when possible (fallback narration)
- MUST log detailed error context for debugging (developer console)
- MUST NOT crash or show "Internal Error" to the player
- SHOULD animate transitions between error and recovery states
- SHOULD allow dismissing non-critical errors to continue play

---

## 4. Implementation Guidance

> Content extracted from Spec 001 Â§13.7

### 4.1 Reference Implementation

For the complete Dart+Flutter reference implementation, see:

- **Spec 002: Plan Execution** (language-agnostic algorithms)
  - `data-model.md` Â§4: Plan Execution Algorithm (topological sort, cycle detection)
  - `data-model.md` Â§2: Plan JSON Structure (includes RetryPolicy with backoff formula)
  - `data-model.md` Â§6: Deep Merge Algorithm (state merge semantics)
  - `data-model.md` Â§5: Replan Loop State Machine
- **Spec 003: Skills Framework** (skill discovery and configuration)
  - Agent Skills Standard manifest format
  - Skill configuration schema
- **Spec 004: Narratoria Skills** (individual skill specifications)
  - Core skills: storyteller, dice-roller, memory, reputation
  - Advanced skills: player-choices, character-portraits, npc-perception
- **This Specification (Spec 005)**
  - `data-model.md`: Dart class implementations
  - `tasks.md`: Implementation tasks

### 4.2 Dart Class Implementations

See [data-model.md](data-model.md) in this specification for complete Dart class definitions:

- `Skill`, `SkillScript`, `ConfigField`, `SkillErrorState`
- `PlanJson`, `ToolInvocation`, `RetryPolicy`, `PlanMetadata`
- `PlanExecutionContext` with topological sort and cycle detection
- `ToolResult`, `ExecutionResult`, `ToolExecutionState`
- Protocol event sealed class hierarchy
- `SessionState` with `DeepMerge` extension
- Exception hierarchy for error handling

### 4.3 Protocol Compliance Testing

Implementations SHOULD validate against:
- `contracts/plan-json.schema.json`: Plan JSON structure (in [Spec 002](../002-plan-execution/contracts/))
- `contracts/execution-result.schema.json`: Execution result structure (in [Spec 002](../002-plan-execution/contracts/))
- `contracts/skill-manifest.schema.json`: Skill manifest structure (in [Spec 003](../003-skills-framework/contracts/))
- `contracts/tool-protocol.openapi.yaml`: Event schema validation (in [Spec 001](../001-tool-protocol-spec/contracts/))

---

## 5. Technology Stack

- **Language**: Dart 3.x
- **Framework**: Flutter SDK (latest stable)
- **Design System**: Material Design 3
- **State Management**: Provider
- **AI Integration**: Flutter AI Toolkit + Ollama
- **Database**: SQLite (via sqflite)
- **Testing**: Flutter test, integration_test

---

## 6. Project Structure

```
src/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ models/           # Dart class implementations
â”‚   â”‚   â”œâ”€â”€ plan_json.dart
â”‚   â”‚   â”œâ”€â”€ protocol_events.dart
â”‚   â”‚   â”œâ”€â”€ session_state.dart
â”‚   â”‚   â””â”€â”€ tool_execution_status.dart
â”‚   â”œâ”€â”€ services/         # Business logic
â”‚   â”‚   â”œâ”€â”€ tool_invoker.dart
â”‚   â”‚   â”œâ”€â”€ plan_executor.dart
â”‚   â”‚   â”œâ”€â”€ narrator_ai.dart
â”‚   â”‚   â”œâ”€â”€ skill_discovery.dart
â”‚   â”‚   â””â”€â”€ skill_config.dart
â”‚   â””â”€â”€ ui/               # Flutter widgets
â”‚       â”œâ”€â”€ screens/
â”‚       â”‚   â”œâ”€â”€ main_screen.dart
â”‚       â”‚   â”œâ”€â”€ storytelling_screen.dart
â”‚       â”‚   â””â”€â”€ skills_settings_screen.dart
â”‚       â””â”€â”€ widgets/
â”‚           â”œâ”€â”€ tool_execution_panel.dart
â”‚           â”œâ”€â”€ asset_gallery.dart
â”‚           â”œâ”€â”€ narrative_state_panel.dart
            â”œâ”€â”€ player_choice_interface.dart
â”‚           â””â”€â”€ story_view.dart
â””â”€â”€ skills/               # Skill implementations (per Spec 004)
    â”œâ”€â”€ storyteller/      # Rich narrative enhancement
    â”‚   â”œâ”€â”€ skill.json
    â”‚   â”œâ”€â”€ config-schema.json
    â”‚   â”œâ”€â”€ prompt.md
    â”‚   â””â”€â”€ narrate.dart
    â”œâ”€â”€ dice-roller/      # Randomness and game mechanics
    â”‚   â”œâ”€â”€ skill.json
    â”‚   â””â”€â”€ roll-dice.dart
    â”œâ”€â”€ memory/           # Semantic memory and continuity
    â”‚   â”œâ”€â”€ skill.json
    â”‚   â”œâ”€â”€ store-memory.dart
    â”‚   â””â”€â”€ recall-memory.dart
    â””â”€â”€ reputation/       # Faction standing tracking
        â”œâ”€â”€ skill.json
        â”œâ”€â”€ update-reputation.dart
        â””â”€â”€ query-reputation.dart
```

---

## 7. Cross-References

| This Spec | References |
|-----------|------------|
| Â§2 Flutter UI | Implements Spec 001 event display requirements |
| Â§3 MVP | Implements Spec 001 protocol compliance, Spec 004 core skills |
| Â§4 Guidance | Implements Spec 002 execution algorithms |
| Â§5 Tech Stack | Constrained by Spec 003 skill requirements |
| Â§6 Structure | Organizes Spec 003 skill framework, Spec 004 skill implementations |

---

## Related Specifications

| Specification | Relationship |
|---------------|--------------|
| [001: Tool Protocol](../001-tool-protocol-spec/spec.md) | Language-agnostic protocol contracts |
| [002: Plan Execution](../002-plan-execution/spec.md) | Plan JSON schema, execution semantics, replan loop |
| [003: Skills Framework](../003-skills-framework/spec.md) | Skill discovery, configuration, Agent Skills Standard |
| [004: Narratoria Skills](../004-narratoria-skills/spec.md) | Individual skill specifications |
