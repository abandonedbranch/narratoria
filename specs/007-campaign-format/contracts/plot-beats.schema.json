{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://narratoria.dev/schemas/campaign/plot-beats.schema.json",
  "title": "Plot Beats Collection",
  "description": "Structured plot beats for Narratoria campaigns - key story moments the AI works toward",
  "type": "object",
  "required": ["beats"],
  "properties": {
    "beats": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/PlotBeat"
      },
      "minItems": 1,
      "description": "Array of plot beats defining story structure"
    }
  },
  "definitions": {
    "PlotBeat": {
      "type": "object",
      "required": ["id", "title", "description"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^beat_[0-9]{3,}$",
          "description": "Unique beat identifier (e.g., 'beat_001')",
          "examples": ["beat_001", "beat_042"]
        },
        "title": {
          "type": "string",
          "minLength": 3,
          "maxLength": 100,
          "description": "Brief beat title for reference",
          "examples": ["The Betrayal Revealed", "Vision of the Future", "Final Confrontation"]
        },
        "description": {
          "type": "string",
          "minLength": 10,
          "maxLength": 1000,
          "description": "Detailed description of what happens in this beat",
          "examples": [
            "Arthur learns the truth about his parentage from Morgana, causing a crisis of identity",
            "Merlin has a prophetic vision showing Camelot in flames and Arthur dead"
          ]
        },
        "conditions": {
          "type": "object",
          "description": "Conditions that trigger this beat",
          "properties": {
            "scene_count": {
              "type": "object",
              "properties": {
                "min": {
                  "type": "integer",
                  "minimum": 0,
                  "description": "Minimum scene count before this beat can trigger"
                },
                "max": {
                  "type": "integer",
                  "minimum": 0,
                  "description": "Maximum scene count - beat should trigger by this point"
                }
              },
              "description": "Scene count range for beat trigger window"
            },
            "requires_beat": {
              "oneOf": [
                {
                  "type": "string",
                  "pattern": "^beat_[0-9]{3,}$",
                  "description": "Single prerequisite beat ID"
                },
                {
                  "type": "array",
                  "items": {
                    "type": "string",
                    "pattern": "^beat_[0-9]{3,}$"
                  },
                  "description": "Multiple prerequisite beat IDs (all required)"
                }
              ],
              "description": "Beat(s) that must complete before this one"
            },
            "requires_any_beat": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^beat_[0-9]{3,}$"
              },
              "description": "Beat IDs where at least one must complete before this one"
            },
            "player_choice": {
              "type": "string",
              "description": "Specific player choice that enables this beat",
              "examples": ["investigated_past", "trusted_morgana", "refused_quest"]
            },
            "player_choices": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Multiple player choices that all must occur"
            },
            "player_state": {
              "type": "string",
              "description": "Required player state or condition",
              "examples": ["established in Camelot", "has excalibur", "morgana_relationship_hostile"]
            },
            "npc_state": {
              "type": "object",
              "additionalProperties": {
                "type": "string"
              },
              "description": "Required NPC states (key = NPC name, value = state)",
              "examples": [{
                "morgana": "betrayed",
                "arthur": "crowned"
              }]
            },
            "world_state": {
              "type": "object",
              "additionalProperties": true,
              "description": "Required world conditions",
              "examples": [{
                "camelot_status": "at_war",
                "excalibur_location": "stone"
              }]
            },
            "custom": {
              "type": "object",
              "description": "Custom condition logic (system-defined evaluation)",
              "examples": [{
                "expression": "player.reputation > 50 && arthur.trust > 70"
              }]
            }
          },
          "additionalProperties": false
        },
        "priority": {
          "type": "string",
          "enum": ["critical", "high", "medium", "low", "optional"],
          "description": "Beat priority - critical beats are story-essential",
          "default": "medium"
        },
        "consequences": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 5
          },
          "description": "What changes after this beat completes",
          "examples": [[
            "Relationship with Uther: destroyed",
            "Arthur gains 'Identity Crisis' trait",
            "Morgana becomes active antagonist"
          ]]
        },
        "outcomes": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["description"],
            "properties": {
              "description": {
                "type": "string",
                "description": "Outcome description"
              },
              "triggers_beat": {
                "type": "string",
                "pattern": "^beat_[0-9]{3,}$",
                "description": "Beat ID that this outcome enables"
              },
              "probability": {
                "type": "number",
                "minimum": 0,
                "maximum": 1,
                "description": "Probability of this outcome (0.0 to 1.0)"
              }
            }
          },
          "description": "Possible outcomes from this beat (for branching narratives)"
        },
        "dialogue": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["speaker", "line"],
            "properties": {
              "speaker": {
                "type": "string",
                "description": "Character name speaking this line"
              },
              "line": {
                "type": "string",
                "description": "The dialogue line"
              },
              "context": {
                "type": "string",
                "description": "When/how this line is delivered"
              }
            }
          },
          "description": "Key dialogue lines that should appear in this beat"
        },
        "location": {
          "type": "string",
          "description": "Where this beat typically occurs",
          "examples": ["Throne Room of Camelot", "Dark Forest Clearing", "Merlin's Tower"]
        },
        "mood": {
          "type": "string",
          "description": "Emotional tone of this beat",
          "examples": ["Tense", "Melancholic", "Triumphant", "Foreboding"]
        },
        "music": {
          "type": "string",
          "pattern": "^music/",
          "description": "Optional music track path for this beat",
          "examples": ["music/beats/betrayal_theme.mp3"]
        },
        "background": {
          "type": "string",
          "pattern": "^art/",
          "description": "Optional background image path for this beat",
          "examples": ["art/locations/throne_room.jpg"]
        },
        "skippable": {
          "type": "boolean",
          "description": "Whether this beat can be skipped if conditions become impossible",
          "default": false
        },
        "timeout": {
          "type": "object",
          "properties": {
            "scene_count": {
              "type": "integer",
              "minimum": 1,
              "description": "Number of scenes after which this beat times out"
            },
            "fallback_beat": {
              "type": "string",
              "pattern": "^beat_[0-9]{3,}$",
              "description": "Fallback beat if this one times out"
            }
          },
          "description": "Timeout behavior if beat conditions aren't met"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "maxItems": 10,
          "description": "Searchable tags for this beat",
          "examples": [["revelation", "betrayal", "combat", "choice"]]
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
