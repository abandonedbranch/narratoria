# Specification 003: Dart/Flutter Implementation and UX

> **Status**: Draft
> **Version**: 0.1.0
> **Parent Specs**: [001-tool-protocol-spec](../001-tool-protocol-spec/spec.md), [002-plan-generation-skills](../002-plan-generation-skills/spec.md)

## 1. Purpose

This specification defines the Dart+Flutter reference implementation of the Narratoria platform, implementing the contracts defined in Spec 001 (Tool Protocol) and the architectural patterns defined in Spec 002 (Plan Generation Skills).

**Scope includes:**
- Flutter UI implementation with Material Design 3
- Dart class implementations of protocol entities and architectural components
- MVP feature requirements and example tools
- Project structure and file organization
- Implementation guidance and best practices

**Scope excludes:**
- Protocol definitions (see Spec 001)
- Architectural patterns and algorithms (see Spec 002)
- Language-agnostic contracts and schemas

---

## 2. Flutter UI Requirements

> Content extracted from Spec 001 §12

### 2.1 Design System

Narratoria MUST use **Material Design 3** for its Flutter UI. This provides:
- First-class Flutter support with extensive widget library
- Cross-platform consistency (macOS, Windows, Linux)
- Excellent testability via `flutter_test`
- Mature theming and customization

### 2.2 Core UI Components

The Narratoria client MUST implement these components:

#### Tool Execution Panel
Displays active tool invocations with real-time progress:
- Tool name and current status
- Streaming log output (from `log` events)
- Progress indicators for long-running operations
- Error display (from `error` events)
- Completion status (from `done` events)

#### Asset Gallery
Displays assets generated by tools (from `asset` events):
- Image preview with metadata
- Audio player controls
- Video player controls
- **Graceful degradation**: Placeholder cards for unsupported `mediaType` values showing asset details

#### Narrative State Panel
Displays current session state:
- Expandable tree view of state objects
- State changes highlighted (from `state_patch` events)
- JSON inspector for debugging

#### Player Input Field
Natural language textarea for player prompts:
- Multiline text input
- Send button to submit prompt
- Visual feedback during processing

### 2.3 UI Layout

```
┌─────────────────────────────────────────────┐
│  NavigationRail   │   Main Content Area     │
│                   │                         │
│  • Narrative      │  ┌──────────────────┐  │
│  • Tools          │  │  Story View      │  │
│  • Assets         │  │  (narrative text │  │
│  • State          │  │   + assets)      │  │
│                   │  └──────────────────┘  │
│                   │                         │
│                   │  ┌──────────────────┐  │
│                   │  │  Player Input    │  │
│                   │  │  [text field]    │  │
│                   │  └──────────────────┘  │
└─────────────────────────────────────────────┘
```

### 2.4 Theming

The client MUST implement a dark-themed Material Design 3 scheme suitable for immersive storytelling:

```dart
ThemeData(
  useMaterial3: true,
  colorScheme: ColorScheme.fromSeed(
    seedColor: Colors.deepPurple,
    brightness: Brightness.dark,
  ),
  typography: Typography.material2021(),
)
```

---

## 3. MVP Requirements

> Content extracted from Spec 001 §14

To deliver a minimum viable product that demonstrates the protocol and player interaction flow, the Narratoria client MUST implement:

### 3.1 Core Features (MUST)

1. **Player Input**: Text field accepting natural language prompts
2. **Narrator AI Stub**: In-process Dart service that converts prompts to Plan JSON using hard-coded mappings (e.g., "light torch" → torch-lighter tool invocation). This mock implementation can be replaced with actual LLM integration in future iterations without changing the PlanExecutor interface.
3. **Tool Invocation**: Execute tools per Plan JSON using process launch and stdin/stdout pipes
4. **Event Processing**: Parse NDJSON from tool stdout and dispatch to handlers
5. **UI Event Support**: Implement `narrative_choice` handler (display choice buttons; other events degrade gracefully)
6. **State Management**: Maintain session state, apply `state_patch` events using deep merge
7. **Asset Registry**: Store asset metadata from `asset` events
8. **UI Panels**:
   - Story View (narrative text + rendered assets)
   - Tool Execution Panel (logs, progress)
   - Asset Gallery (images, audio, video with graceful degradation)
   - Narrative State Panel (JSON inspector)

### 3.2 Example Tools (SHOULD)

For MVP validation, provide at least two example tools:

1. **torch-lighter**: Receives `{action: "light_torch"}`, emits:
   - `log` event: "Lighting torch..."
   - `state_patch` event: `{"inventory": {"torch": {"lit": true}}}`
   - `asset` event: image of lit torch (PNG file)
   - `done` event: `{"ok": true, "summary": "Torch lit."}`

2. **door-examiner**: Receives `{target: "mysterious_door"}`, emits:
   - `log` event: "Examining door..."
   - `state_patch` event: `{"discovered": {"door_inscription": "Ancient runes"}}`
   - `ui_event` event: `{"event": "narrative_choice", "payload": {"choices": ["Open", "Leave"]}}`
   - `done` event: `{"ok": true, "summary": "Door examined."}`

### 3.3 Sample Plan JSON

For prompt "I light the torch and examine the door" (first attempt):

```json
{
  "requestId": "550e8400-e29b-41d4-a716-446655440000",
  "narrative": "You reach for the torch on the wall.",
  "tools": [
    {
      "toolId": "light1",
      "toolPath": "tools/torch-lighter",
      "input": {"action": "light_torch"},
      "dependencies": [],
      "required": true,
      "async": false,
      "retryPolicy": {"maxRetries": 3, "backoffMs": 100}
    },
    {
      "toolId": "examine1",
      "toolPath": "tools/door-examiner",
      "input": {"target": "mysterious_door"},
      "dependencies": ["light1"],
      "required": true,
      "async": false,
      "retryPolicy": {"maxRetries": 3, "backoffMs": 100}
    }
  ],
  "parallel": false,
  "disabledSkills": [],
  "metadata": {
    "generationAttempt": 1,
    "parentPlanId": null
  }
}
```

If torch-lighter fails after 3 retries, execution trace shows failure. Narrator AI generates Plan 2:

```json
{
  "requestId": "550e8400-e29b-41d4-a716-446655440001",
  "narrative": "The torch is beyond reach. You examine the mysterious door instead.",
  "tools": [
    {
      "toolId": "examine2",
      "toolPath": "tools/door-examiner",
      "input": {"target": "mysterious_door"},
      "dependencies": [],
      "required": true,
      "async": false
    }
  ],
  "parallel": false,
  "disabledSkills": ["torch-lighter"],
  "metadata": {
    "generationAttempt": 2,
    "parentPlanId": "550e8400-e29b-41d4-a716-446655440000"
  }
}
```

This demonstrates sequential execution with dependency tracking, retry policies, and replan logic. Tool specifications are defined in §3.2 above.

---

## 4. Implementation Guidance

> Content extracted from Spec 001 §13.7

### 4.1 Reference Implementation

For the complete Dart+Flutter reference implementation, see:

- **Spec 002: Plan Generation and Skill Discovery** (language-agnostic algorithms)
  - `data-model.md` §4: Plan Execution Algorithm (topological sort, cycle detection)
  - `data-model.md` §2: Plan JSON Structure (includes RetryPolicy with backoff formula)
  - `data-model.md` §6: Deep Merge Algorithm (state merge semantics)
  - `data-model.md` §5: Replan Loop State Machine
- **This Specification (Spec 003)**
  - `data-model.md`: Dart class implementations
  - `tasks.md`: Implementation tasks

### 4.2 Dart Class Implementations

See [data-model.md](data-model.md) in this specification for complete Dart class definitions:

- `Skill`, `SkillScript`, `ConfigField`, `SkillErrorState`
- `PlanJson`, `ToolInvocation`, `RetryPolicy`, `PlanMetadata`
- `PlanExecutionContext` with topological sort and cycle detection
- `ToolResult`, `ExecutionResult`, `ToolExecutionState`
- Protocol event sealed class hierarchy
- `SessionState` with `DeepMerge` extension
- Exception hierarchy for error handling

### 4.3 Protocol Compliance Testing

Implementations SHOULD validate against:
- `contracts/plan-json.schema.json`: Plan JSON structure (in Spec 002)
- `contracts/execution-result.schema.json`: Execution result structure (in Spec 002)
- `contracts/tool-protocol.openapi.yaml`: Event schema validation (in Spec 001)

---

## 5. Technology Stack

- **Language**: Dart 3.x
- **Framework**: Flutter SDK (latest stable)
- **Design System**: Material Design 3
- **State Management**: Provider
- **AI Integration**: Flutter AI Toolkit + Ollama
- **Database**: SQLite (via sqflite)
- **Testing**: Flutter test, integration_test

---

## 6. Project Structure

```
src/
├── lib/
│   ├── models/           # Dart class implementations
│   │   ├── plan_json.dart
│   │   ├── protocol_events.dart
│   │   ├── session_state.dart
│   │   └── tool_execution_status.dart
│   ├── services/         # Business logic
│   │   ├── tool_invoker.dart
│   │   ├── plan_executor.dart
│   │   ├── narrator_ai.dart
│   │   ├── skill_discovery.dart
│   │   └── skill_config.dart
│   └── ui/               # Flutter widgets
│       ├── screens/
│       │   ├── main_screen.dart
│       │   ├── storytelling_screen.dart
│       │   └── skills_settings_screen.dart
│       └── widgets/
│           ├── tool_execution_panel.dart
│           ├── asset_gallery.dart
│           ├── narrative_state_panel.dart
│           ├── player_input_field.dart
│           └── story_view.dart
├── skills/               # Skill implementations
│   ├── storyteller/
│   ├── memory/
│   └── reputation/
└── tools/                # Example tools
    ├── torch-lighter/
    └── door-examiner/
```

---

## 7. Cross-References

| This Spec | References |
|-----------|------------|
| §2 Flutter UI | Implements Spec 001 event display requirements |
| §3 MVP | Implements Spec 001 protocol compliance |
| §4 Guidance | Implements Spec 002 execution algorithms |
| §5 Tech Stack | Constrained by Spec 002 skill requirements |
| §6 Structure | Organizes Spec 002 service interfaces |

---

## Related Specifications

- **[Spec 001: Tool Protocol](../001-tool-protocol-spec/spec.md)** - Language-agnostic protocol contracts
- **[Spec 002: Plan Generation Skills](../002-plan-generation-skills/spec.md)** - System behavior and skill lifecycle
