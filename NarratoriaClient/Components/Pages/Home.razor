@page "/"
@rendermode Microsoft.AspNetCore.Components.Web.RenderMode.InteractiveServer

@implements IDisposable
@inject INarrationService NarrationService

<PageTitle>Narratoria</PageTitle>

<DockLayout Class="home-layout">
    <DockSection Side="DockSide.Center">
        <section class="home-panel home-scrollback">
            <div class="home-scrollback__header">
                <h2>@SessionHeading</h2>
                <p>@SessionSubheading</p>
            </div>
            <ChatScrollback Messages="@ChatHistory"
                            OnDeleteMessage="HandleDeleteMessageAsync" />
        </section>
    </DockSection>

    <DockSection Side="DockSide.Bottom">
        <section class="home-panel home-editor">
            <CommandHost ResetKey="@_activeSession?.SessionId" />
            <div class="home-editor__body">
                <NarrationStatusIndicator CssClass="status-inline" />
                <ReplyEditor OnSend="HandleSendAsync" />
            </div>
        </section>
    </DockSection>
</DockLayout>

@code {
    [Inject] private IAppDataService AppData { get; set; } = default!;

    private readonly List<ChatScrollback.ChatMessage> _chatHistory = new();
    private ChatSessionSummary? _activeSession;
    private bool _clientReady;
    private bool _isSending;

    private IReadOnlyList<ChatScrollback.ChatMessage> ChatHistory => _chatHistory;
    private string SessionHeading => _activeSession is null ? "Story scrollback" : $"Story scrollback â€” {_activeSession.Name}";
    private string SessionSubheading => _activeSession is null
        ? "Everything the narrator and cast have shared so far."
        : BuildSessionSubheading();

    protected override async Task OnInitializedAsync()
    {
        AppData.ChatSessionChanged += HandleChatSessionChanged;
        AppData.SessionsChanged += HandleSessionsChanged;
        _activeSession = await AppData.GetActiveSessionSummaryAsync();
        var messages = await AppData.GetChatHistoryAsync();
        UpdateHistory(messages);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_clientReady)
        {
            return;
        }

        try
        {
            await AppData.NotifyClientReadyAsync();
        }
        catch (ClientStorageUnavailableException)
        {
            return;
        }

        _clientReady = true;

        var messages = await AppData.GetChatHistoryAsync();
        if (messages.Count == 0)
        {
            messages = await AppData.GetChatHistoryAsync();
        }

        UpdateHistory(messages);
        _activeSession = await AppData.GetActiveSessionSummaryAsync();

        await InvokeAsync(StateHasChanged);
    }

    private void HandleChatSessionChanged(object? sender, IReadOnlyList<ChatMessageEntry> messages)
    {
        _ = InvokeAsync(async () =>
        {
            UpdateHistory(messages);
            _activeSession = await AppData.GetActiveSessionSummaryAsync();
            StateHasChanged();
        });
    }

    private void HandleSessionsChanged(object? sender, IReadOnlyList<ChatSessionSummary> summaries)
    {
        _activeSession = summaries.FirstOrDefault(s => s.IsActive) ?? _activeSession;
        _ = InvokeAsync(StateHasChanged);
    }

    private async Task HandleSendAsync(string message)
    {
        if (string.IsNullOrWhiteSpace(message) || _isSending)
        {
            return;
        }

        _isSending = true;
        try
        {
            await NarrationService.ProcessPlayerMessageAsync(message);
        }
        catch (OperationCanceledException)
        {
            // Ignore cancellation triggered by navigation or refresh.
        }
        finally
        {
            _isSending = false;
        }
    }

    private void UpdateHistory(IEnumerable<ChatMessageEntry> messages)
    {
        _chatHistory.Clear();
        foreach (var entry in messages)
        {
            _chatHistory.Add(new ChatScrollback.ChatMessage(entry.Id, entry.Author, entry.Content));
        }
    }

    private async Task HandleDeleteMessageAsync(string messageId)
    {
        if (string.IsNullOrWhiteSpace(messageId))
        {
            return;
        }

        await AppData.DeleteMessageAsync(messageId);
    }

    private string BuildSessionSubheading()
    {
        if (_activeSession is null)
        {
            return string.Empty;
        }

        var total = _activeSession.MessageCount;
        var startAgo = FormatRelativeTime(_activeSession.CreatedAt);
        var endReference = _activeSession.MessageCount > 0 ? _activeSession.UpdatedAt : _activeSession.CreatedAt;
        var lastAgo = FormatRelativeTime(endReference);

        return $"{total} item{(total == 1 ? string.Empty : "s")}, started {startAgo}, last activity {lastAgo}";
    }

    private static string FormatRelativeTime(DateTimeOffset timestamp)
    {
        var now = DateTimeOffset.UtcNow;
        var difference = now - timestamp;

        if (difference.TotalSeconds < 60)
        {
            return "just now";
        }

        if (difference.TotalMinutes < 60)
        {
            var minutes = (int)Math.Floor(difference.TotalMinutes);
            return minutes == 1 ? "1 minute ago" : $"{minutes} minutes ago";
        }

        if (difference.TotalHours < 24)
        {
            var hours = (int)Math.Floor(difference.TotalHours);
            return hours == 1 ? "1 hour ago" : $"{hours} hours ago";
        }

        if (difference.TotalDays < 7)
        {
            var days = (int)Math.Floor(difference.TotalDays);
            return days == 1 ? "1 day ago" : $"{days} days ago";
        }

        if (difference.TotalDays < 30)
        {
            var weeks = (int)Math.Floor(difference.TotalDays / 7);
            return weeks == 1 ? "1 week ago" : $"{weeks} weeks ago";
        }

        if (difference.TotalDays < 365)
        {
            var months = (int)Math.Floor(difference.TotalDays / 30);
            return months == 1 ? "1 month ago" : $"{months} months ago";
        }

        var years = (int)Math.Floor(difference.TotalDays / 365);
        return years == 1 ? "1 year ago" : $"{years} years ago";
    }

    public void Dispose()
    {
        AppData.ChatSessionChanged -= HandleChatSessionChanged;
        AppData.SessionsChanged -= HandleSessionsChanged;
    }
}
