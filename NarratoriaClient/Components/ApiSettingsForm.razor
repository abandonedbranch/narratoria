@using Microsoft.AspNetCore.Components.Forms
@implements IChatCommandComponent
@implements IDisposable

<EditForm Model="_formModel" OnValidSubmit="HandleSubmitAsync" class="api-settings-form">
    <DataAnnotationsValidator />
    <Grid RowGap="1.5rem" ColumnGap="1.25rem" MinColumnWidth="14rem">
        <Row Columns="2">
            <Column Class="label-cell">
                <label for="endpoint">Endpoint</label>
            </Column>
            <Column>
                <InputText id="endpoint"
                           @bind-Value="_formModel.Endpoint"
                           placeholder="https://api.example.com"
                           autocomplete="off" />
            </Column>
        </Row>

        <Row Columns="2">
            <Column Class="label-cell">
                <label for="toggle-api-key">API Key required?</label>
            </Column>
            <Column class="toggle-cell">
                <InputCheckbox id="toggle-api-key" @bind-Value="_formModel.ApiKeyRequired" />
                <span>Require key</span>
            </Column>
        </Row>

        <Row Columns="2">
            <Column Class="label-cell">
                <label for="apiKey">API Key @if (!_formModel.ApiKeyRequired) { <span class="optional-label">(optional)</span> }</label>
            </Column>
            <Column>
                <InputText id="apiKey"
                           type="password"
                           @bind-Value="_formModel.ApiKey"
                           placeholder="sk-..."
                           autocomplete="new-password"
                           Disabled="@(!_formModel.ApiKeyRequired)"
                           required="@_formModel.ApiKeyRequired" />
            </Column>
        </Row>

        <Row>
            <Column ColumnSpan="2">
                <details class="help-panel">
                    <summary>Need help connecting?</summary>
                    <p>
                        Enter the base URL for the service plus an API key that follows the OpenAI-compatible format.
                        Narratoria will send requests just like the standard OpenAI SDK.
                    </p>
                    <ul>
                        <li><a href="https://platform.openai.com/signup" target="_blank" rel="noopener noreferrer">Create an OpenAI Platform account</a></li>
                        <li><a href="https://platform.deepseek.com" target="_blank" rel="noopener noreferrer">Explore DeepSeek APIs</a></li>
                        <li><a href="https://huggingface.co/join" target="_blank" rel="noopener noreferrer">Sign up for Hugging&nbsp;Face</a></li>
                    </ul>
                    <p class="tos-note">
                        Narratoria is not affiliated with these providers. Always follow their Terms of Service,
                        including restrictions on adult or disallowed content, when using their APIs.
                    </p>
                </details>
            </Column>
        </Row>

        <Row>
            <Column ColumnSpan="2">
                <h3>Model pathways</h3>
                <p class="pathway-intro">
                    Assign specialized models for each Narratoria flow. The narrator pathway drives the story,
                    the system pathway powers internal automation, and images will unlock visual storytelling soon.
                </p>
            </Column>
        </Row>

        @foreach (var pathway in _formModel.Pathways)
        {
            <Row Columns="2" @key="pathway.Key">
                <Column Class="label-cell">
                    <div class="pathway-label">
                        <label for="@($"model-{pathway.Key}")">@pathway.Title</label>
                        <p class="pathway-description">@pathway.Description</p>
                    </div>
                </Column>
                <Column>
                    <InputText id="@($"model-{pathway.Key}")"
                               @bind-Value="pathway.Model"
                               autocomplete="off"
                               placeholder="gpt-4o-mini"
                               disabled="@pathway.IsDisabled" />
                    @if (pathway.IsAdvanced)
                    {
                        <p class="pathway-warning">Advanced: Narratoria uses this internally. Adjust only if you know the risks.</p>
                    }
                    @if (pathway.IsDisabled)
                    {
                        <p class="pathway-warning">Coming soon. Image generation is currently turned off.</p>
                    }
                </Column>
            </Row>
        }

        <Row>
            <Column Class="actions" ColumnSpan="2">
                <button type="submit" disabled="@_isSaving">Save Settings</button>
            </Column>
        </Row>
    </Grid>
</EditForm>

@code {
    [Inject] private IAppDataService AppData { get; set; } = default!;

    private ApiSettingsModel _formModel = new();
    private bool _initialized;
    private bool _isSaving;

    public string CommandToken => "settings";
    public string DisplayName => "Narrator Settings";
    public string Description => "Configure how Narratoria connects to your storytelling API.";

    private sealed class ApiSettingsModel
    {
        public string Endpoint { get; set; } = string.Empty;
        public string ApiKey { get; set; } = string.Empty;
        public bool ApiKeyRequired { get; set; } = true;
        public List<PathwayBinding> Pathways { get; set; } = new();
    }

    private sealed class PathwayBinding
    {
        public PathwayBinding(string key, string title, string description, bool isDisabled = false, bool isAdvanced = false)
        {
            Key = key;
            Title = title;
            Description = description;
            IsDisabled = isDisabled;
            IsAdvanced = isAdvanced;
        }

        public string Key { get; }
        public string Title { get; }
        public string Description { get; }
        public bool IsDisabled { get; }
        public bool IsAdvanced { get; }
        public string Model { get; set; } = string.Empty;
        public string Mode { get; set; } = string.Empty;
        public bool Enabled { get; set; } = true;
    }

    protected override async Task OnInitializedAsync()
    {
        AppData.SettingsChanged += HandleSettingsChanged;
        await LoadAsync();
        _initialized = true;
    }

    private async Task HandleSubmitAsync()
    {
        if (_isSaving)
        {
            return;
        }

        _isSaving = true;
        try
        {
            var payload = new ApiSettings
            {
                Endpoint = _formModel.Endpoint,
                ApiKey = _formModel.ApiKey,
                ApiKeyRequired = _formModel.ApiKeyRequired,
                Narrator = BuildPathwaySettings("narrator", ModelPathwaySettings.CreateNarratorDefault),
                System = BuildPathwaySettings("system", ModelPathwaySettings.CreateSystemDefault),
                Image = BuildPathwaySettings("image", ModelPathwaySettings.CreateImageDefault)
            };

            await AppData.UpdateApiSettingsAsync(payload);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task LoadAsync()
    {
        var settings = await AppData.GetApiSettingsAsync();
        _formModel = new ApiSettingsModel
        {
            Endpoint = settings.Endpoint,
            ApiKey = settings.ApiKey,
            ApiKeyRequired = settings.ApiKeyRequired,
            Pathways = new List<PathwayBinding>
            {
                CreatePathwayBinding("narrator", "Narrator responses", "Used for storytelling replies players read every turn.", settings.Narrator),
                CreatePathwayBinding("system", "System automation", "Feeds Narratoria's background summarizers and diagnostics.", settings.System, isAdvanced: true),
                CreatePathwayBinding("image", "Image generation", "Reserved for future visual storytelling features.", settings.Image, isDisabled: true)
            }
        };
    }

    private PathwayBinding CreatePathwayBinding(string key, string title, string description, ModelPathwaySettings settings, bool isDisabled = false, bool isAdvanced = false)
    {
        return new PathwayBinding(key, title, description, isDisabled, isAdvanced)
        {
            Model = settings.Model,
            Mode = settings.Mode,
            Enabled = settings.Enabled
        };
    }

    private ModelPathwaySettings BuildPathwaySettings(string key, Func<ModelPathwaySettings> factory)
    {
        var binding = _formModel.Pathways.First(p => string.Equals(p.Key, key, StringComparison.OrdinalIgnoreCase));
        var fallback = factory();
        return fallback with
        {
            Model = string.IsNullOrWhiteSpace(binding.Model) ? fallback.Model : binding.Model,
            Mode = string.IsNullOrWhiteSpace(binding.Mode) ? fallback.Mode : binding.Mode,
            Enabled = binding.IsDisabled ? fallback.Enabled : binding.Enabled
        };
    }

    private void HandleSettingsChanged(object? sender, AppSettings settings)
    {
        if (!_initialized)
        {
            return;
        }

        _ = InvokeAsync(async () =>
        {
            await LoadAsync();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        AppData.SettingsChanged -= HandleSettingsChanged;
    }
}
