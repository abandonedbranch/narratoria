@implements IAsyncDisposable
@implements IChatCommandComponent

<section class="export-settings">
    <h2>Export Your Settings</h2>
    <p>Generate a portable snapshot of your configuration for safekeeping or to share across devices.</p>
    <button type="button" @onclick="HandleExportAsync" disabled="@_isExporting">Export All Settings</button>
    @if (!string.IsNullOrEmpty(_statusMessage))
    {
        <p class="export-status">@_statusMessage</p>
    }
</section>

@code {
    [Inject] private IAppDataService AppData { get; set; } = default!;
    [Inject] private IJSRuntime JS { get; set; } = default!;

    private bool _isExporting;
    private string? _statusMessage;
    private IJSObjectReference? _module;

    public string CommandToken => "export";
    public string DisplayName => "Export Settings";
    public string Description => "Download a snapshot of your configuration and sessions.";

    private async Task HandleExportAsync()
    {
        if (_isExporting)
        {
            return;
        }

        _isExporting = true;
        _statusMessage = null;

        try
        {
            var json = await AppData.ExportAsync();
            _module ??= await JS.InvokeAsync<IJSObjectReference>("import", "./js/fileInterop.js");
            var fileName = $"narratoria-settings-{DateTime.UtcNow:yyyyMMddHHmmss}.json";
            await _module.InvokeVoidAsync("downloadJson", fileName, json);
            _statusMessage = "Export complete.";
        }
        catch (JSDisconnectedException)
        {
            // Circuit ended before export could finish; nothing else to do.
        }
        catch (JSException)
        {
            _statusMessage = "Export failed. Please try again.";
        }
        finally
        {
            _isExporting = false;
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_module is not null)
        {
            try
            {
                await _module.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Browser disconnected before cleanup; safe to ignore.
            }
        }
    }
}
