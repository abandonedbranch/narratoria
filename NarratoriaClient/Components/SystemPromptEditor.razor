@using Microsoft.AspNetCore.Components.Forms
@implements IChatCommandComponent
@implements IDisposable

<EditForm Model="_model" OnValidSubmit="HandleSubmitAsync" class="system-prompt-editor">
    <DataAnnotationsValidator />

    <section class="prompt-section">
        <header>
            <h3>Narrator prompt</h3>
            <p>This is what the player sees. Keep it descriptive, collaborative, and fun.</p>
        </header>

        <Grid RowGap="1rem" ColumnGap="1rem" MinColumnWidth="14rem">
            <Row Columns="2">
                <Column Class="label-cell">
                    <label for="promptTitle-narrator">Prompt Title</label>
                </Column>
                <Column>
                    <InputText id="promptTitle-narrator"
                               @bind-Value="_model.Narrator.Title"
                               placeholder="Epic narrator" />
                </Column>
            </Row>

            <Row Columns="2">
                <Column Class="label-cell">
                    <label for="promptMode-narrator">Mode</label>
                </Column>
                <Column>
                    <InputSelect id="promptMode-narrator"
                                 @bind-Value="_model.Narrator.Mode"
                                 disabled>
                        <option value="Narration">Narration</option>
                        <option value="System">System</option>
                        <option value="Images">Images</option>
                    </InputSelect>
                </Column>
            </Row>

            <Row>
                <Column ColumnSpan="2">
                    <label for="promptContent-narrator">Narrator prompt</label>
                </Column>
            </Row>

            <Row>
                <Column ColumnSpan="2">
                    <InputTextArea id="promptContent-narrator"
                                   @bind-Value="_model.Narrator.Content"
                                   rows="10"
                                   placeholder="You are an evocative storyteller..." />
                </Column>
            </Row>
        </Grid>
    </section>

    <section class="prompt-section prompt-section--system">
        <header>
            <h3>System prompt</h3>
            <p class="system-warning">
                Narratoria uses this internally for summarization and logging. Editing is optional and only recommended for advanced workflows.
            </p>
        </header>

        <Grid RowGap="1rem" ColumnGap="1rem" MinColumnWidth="14rem">
            <Row Columns="2">
                <Column Class="label-cell">
                    <label for="promptTitle-system">Prompt Title</label>
                </Column>
                <Column>
                    <InputText id="promptTitle-system"
                               @bind-Value="_model.System.Title"
                               placeholder="Narratoria system agent" />
                </Column>
            </Row>

            <Row Columns="2">
                <Column Class="label-cell">
                    <label for="promptMode-system">Mode</label>
                </Column>
                <Column>
                    <InputSelect id="promptMode-system"
                                 @bind-Value="_model.System.Mode"
                                 disabled>
                        <option value="System">System</option>
                        <option value="Narration">Narration</option>
                        <option value="Images">Images</option>
                    </InputSelect>
                </Column>
            </Row>

            <Row>
                <Column ColumnSpan="2">
                    <label for="promptContent-system">System instructions</label>
                </Column>
            </Row>

            <Row>
                <Column ColumnSpan="2">
                    <InputTextArea id="promptContent-system"
                                   @bind-Value="_model.System.Content"
                                   rows="10"
                                   placeholder="Explain Narratoria's automation role..." />
                </Column>
            </Row>
        </Grid>
    </section>

    <div class="actions">
        <button type="submit" disabled="@_isSaving">Save Prompts</button>
    </div>
</EditForm>

@code {
    [Inject] private IAppDataService AppData { get; set; } = default!;

    private PromptEditorModel _model = new();
    private bool _isSaving;
    private bool _initialized;

    private sealed class PromptEditorModel
    {
        public PromptForm Narrator { get; set; } = new();
        public PromptForm System { get; set; } = new();
    }

    private sealed class PromptForm
    {
        public string Key { get; set; } = string.Empty;
        public string Title { get; set; } = string.Empty;
        public string Content { get; set; } = string.Empty;
        public string Mode { get; set; } = "Narration";
        public bool IsRecommended { get; set; } = true;
    }

    public string CommandToken => "prompts";
    public string DisplayName => "System Prompt Editor";
    public string Description => "Draft and refine the narrator's guiding prompt.";

    protected override async Task OnInitializedAsync()
    {
        AppData.SettingsChanged += HandleSettingsChanged;
        await LoadAsync();
        _initialized = true;
    }

    private async Task HandleSubmitAsync()
    {
        if (_isSaving)
        {
            return;
        }

        _isSaving = true;
        try
        {
            var payload = new SystemPromptSettings
            {
                Narrator = BuildProfile(_model.Narrator, PromptProfile.CreateNarratorDefault()),
                System = BuildProfile(_model.System, PromptProfile.CreateSystemDefault())
            };

            await AppData.UpdatePromptSettingsAsync(payload);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task LoadAsync()
    {
        var settings = await AppData.GetPromptSettingsAsync();
        _model = new PromptEditorModel
        {
            Narrator = CreatePromptForm(settings.Narrator),
            System = CreatePromptForm(settings.System)
        };
    }

    private static PromptForm CreatePromptForm(PromptProfile profile)
    {
        return new PromptForm
        {
            Key = profile.Key,
            Title = profile.Title,
            Content = profile.Content,
            Mode = profile.Mode,
            IsRecommended = profile.IsRecommended
        };
    }

    private static PromptProfile BuildProfile(PromptForm form, PromptProfile fallback)
    {
        return fallback with
        {
            Title = form.Title,
            Content = form.Content,
            Mode = form.Mode,
            IsRecommended = form.IsRecommended
        };
    }

    private void HandleSettingsChanged(object? sender, AppSettings settings)
    {
        if (!_initialized)
        {
            return;
        }

        _ = InvokeAsync(async () =>
        {
            await LoadAsync();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        AppData.SettingsChanged -= HandleSettingsChanged;
    }
}
