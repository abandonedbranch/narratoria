# Copilot Instructions
- Spec-first repo: specs in [SPEC](SPEC) and [specs/](specs/) are authoritative; update the index when adding/removing specs and log drift/gaps in [TODO](TODO). Coding standards live in [CONTRIB](CONTRIB) (small interfaces, immutability by default, no placeholders).
- Architecture: .NET 10 Blazor Server app. Pipeline is DI-built in [src/Program.cs](src/Program.cs) with middleware order: persistence → system prompt injection → content guardian injection → provider dispatch.
- Pipeline contract: `NarrationPipelineService` composes delegates; `RunAsync` requires a `NarrationContext` and `CancellationToken`. `MiddlewareResult` carries `StreamedNarration` (IAsyncEnumerable) plus `UpdatedContext`. Short-circuiting/exception propagation are middleware-driven; pipeline itself is side-effect free.
- Middleware responsibilities:
  - [NarrationPersistenceMiddleware](src/Narration/NarrationPersistenceMiddleware.cs) loads session state first, merges request metadata (stripping ephemeral system/content-guardian keys), wraps downstream streaming so persistence always runs, and persists merged narration on completion; skips persistence on downstream failure/cancel.
  - [NarrationSystemPromptMiddleware](src/Narration/NarrationSystemPromptMiddleware.cs) resolves a system prompt profile via `ISystemPromptProfileResolver` (config-backed in [ConfigSystemPromptProfileResolver](src/Narration/ConfigSystemPromptProfileResolver.cs)), injects system/instruction segments, and is idempotent per profile/version metadata.
  - [NarrationContentGuardianMiddleware](src/Narration/NarrationContentGuardianMiddleware.cs) injects a safety system prompt unless already applied; expects `WorkingContextSegments` to exist.
  - [ProviderDispatchMiddleware](src/Narration/ProviderDispatchMiddleware.cs) streams tokens from `INarrationProvider`, enforces timeout via `ProviderDispatchOptions`, handles upstream cancellation when enumeration stops, and emits metrics/log telemetry; errors are wrapped in `NarrationPipelineException` with `NarrationPipelineError`.
  - Providers & OpenAI: default provider is [OpenAiNarrationProvider](src/Narration/OpenAiNarrationProvider.cs) backed by `IOpenAiApiService`/`IOpenAiStreamingProvider`. Options bound from `appsettings*.json` to [NarrationOpenAiOptions](src/Narration/NarrationOpenAiOptions.cs) (ApiKey/Model required) and [ProviderDispatchOptions](src/Narration/ProviderDispatchOptions.cs) (Timeout validated on start; Model defaults to OpenAI model if unset).
  - Storage: IndexedDB persistence via [IndexedDbNarrationSessionStore](src/Narration/IndexedDbNarrationSessionStore.cs) using schema built in [Program](src/Program.cs). Serializers are registered (e.g., [NarrationContextSerializer](src/Narration/IndexedDbNarrationSessionStore.cs) and [IndexedDb storage service](src/Storage/IndexedDb/IndexedDbStorageService.cs)); quota metrics come from `IIndexedDbStorageMetrics` (logging implementation registered).
  - UI composition: `NarrationSessionOrchestrator` in [src/Components/NarrationSessionOrchestrator.razor](src/Components/NarrationSessionOrchestrator.razor) wires prompt submission, attachments staging, and runs the pipeline (DI-provided or a built-in fake). It uses `PipelineObserverViewAdapter` and `StageMetadataProvider` to drive chip states/hover metadata for `NarrationPipelineLog`.
- Default test/demo routes: `/test-orchestrator` and `/test-pipeline-log` (see [src/Components/Pages/TestOrchestrator.razor](src/Components/Pages/TestOrchestrator.razor) and [src/Components/Pages/TestPipelineLog.razor](src/Components/Pages/TestPipelineLog.razor)). Launch profile binds HTTP to 5224 and HTTPS to 7090; Playwright tests currently hit `http://localhost:5224` and `https://localhost:5001`, so run with `dotnet run --project src/Narratoria.csproj --urls "https://localhost:5001;http://localhost:5224"` when executing E2E.
- Stage metadata: `StageMetadataProvider` stores hover data keyed by stage/session; observer adapter updates it from pipeline telemetry and applies provider metrics (tokens/model) after streaming completes.
- Cancellation/streaming expectations: callers must pass a `CancellationToken` and enumerate `StreamedNarration`; early disposal must cancel upstream (handled in provider middleware). Persistence wraps the stream to ensure completion telemetry even when iteration stops early.
- Attachments: dropzone component accepts files; ingestion middleware exists but TODO notes wiring into orchestrator is pending and restore-from-store is not implemented.
- Testing: unit tests use MSTest (`dotnet test tests/Narratoria.Tests/Narratoria.Tests.csproj`). Playwright E2E requires browsers installed (`pwsh tests/PlaywrightTests/bin/Debug/net10.0/playwright.ps1 install` after first build) and the app running on the URLs above before `dotnet test tests/PlaywrightTests/PlaywrightTests.csproj`.
- Observability: pipeline/middleware emit metrics via `System.Diagnostics.Metrics` and log structured telemetry (`trace_id`, `request_id`, `session_id`, `stage`, `status`, `error_class`, durations). UI hovers surface duration/token/model when present.
- When adding features: extend/update specs first, keep spec index in [SPEC](SPEC) in sync with [specs/](specs/), capture drift/gaps in [TODO](TODO), and align implementations with [CONTRIB](CONTRIB) rules (small interfaces, immutable records, async/await with cancellation, no placeholders).
