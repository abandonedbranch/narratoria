Journey: Game Startup and Main Menu
====================

Architecture References
- Layer 5: UI Implementation (Story View, Asset Gallery, Settings)
- Layer 6: Skill State Persistence (Session state, memories, reputation)
- Layer 7: Campaign Format (campaign.yml metadata, semantic files, content warnings)
- Section 5.3.1: Context Precedence Hierarchy (frontmatter vs prose weight tiers, No-Shadow Rule, context assembly algorithm)
- Section 6.2: Campaign Format (semantic file structure, campaign.yml schema, player character constraints)
- Section 6.2.6: Player Character Constraints (constraints file format, advisory validation)
- Section 6.3: Campaign Storage and Distribution (discovery algorithm, platform-specific storage)

Involved Layers
- Layer 5: UI Implementation
- Layer 6: Skill State Persistence (session initialization)
- Layer 7: Campaign Format (campaign.yml loading, constraint checking)
- Layer 8: Narrative Engine (scene pipeline entry point)

Key Contracts from Architecture
- Campaign metadata defined in `campaign.yml` with only `title` and `version` required (Section 6.2.3)
- Player character constraints defined in optional `player_character_constraints.yml` or campaign.yml `player_character` section
- Content warnings array defined in campaign.yml (Section 6.2.3)
- Character constraint checking is advisory for fresh characters (no archetype to validate against freeform description)
- Full constraint validation deferred to character realization at campaign load time
- Persistence layer initializes session state from ObjectBox (existing campaign) or starts fresh ingestion
- Campaign discovery scans multiple locations per Section 6.3.6 (built-in, downloaded, iCloud, previous playthroughs)
- During campaign ingestion, frontmatter chunks are tagged `sourceType: frontmatter`, `weightTier: 1` (absolute); prose chunks tagged `sourceType: prose`, `weightTier: 3` (same-file) or `weightTier: 4` (cross-file) per Section 5.3.1
- The No-Shadow Rule applies: frontmatter assertions from one file cannot be overridden by prose from a different file
- Realized player character chunks are stored with `isPlayer: true` and `weightTier: 2` (immediate), enabling the player-agency constraint during context assembly

Consistency Requirements
- All states use UPPER_SNAKE_CASE naming (e.g., APP_LAUNCHING, CAMPAIGN_DETAIL)
- State transitions documented bidirectionally (forward and back button behavior)
- Error states defined: network_timeout, missing_campaign, model_download_failure, insufficient_storage
- Duration estimates provided for all states (used in performance contracts)
- Back button always returns to previous state data (e.g., back from warnings returns to campaign list, not character selection)
- Content warnings must be visible at a glance (no scrolling required to find them)
- Constraint validation is advisory only for fresh characters; informational note shown, not a blocking gate

Error Handling Patterns
- Model download failures: Show retry dialog with manual download link
- Missing campaigns: Display "No campaigns found" with documentation link
- Insufficient storage for models: Show device storage requirements and exit
- Campaign loading failures: Return to campaign selection, show error message
- Network timeouts (iOS iCloud sync): Gracefully fall back to local campaigns, notify user
- Character realization failure: Show error, allow retry or return to character selection

Performance Targets (from Architecture Section: Performance Targets)
- Scene transition latency: <3 seconds (applies to campaign loading phase)
- Model initialization: 2-30 seconds (depends on cache availability)
- Campaign discovery: <2 seconds (for discovered campaigns list to display)
- Character realization (LLM): 5-8 seconds (Phi-4/Phi-4-mini generates realized character from fresh description)
- Campaign ingestion (YAML frontmatter + chunking + embedding + precedence tagging): varies by campaign size

Data Shapes (from Architecture)
- Campaign metadata (campaign.yml): required fields are `title` and `version`; optional fields include `description`, `author`, `content_warnings`, `player_character` constraints, `tags`
- Fresh character: { id, status, created_at, description, portrait_path, realizations[] }
- Content warning: { type: string, description: string, severity: "mild"|"moderate"|"severe" }
- Session state: { character_id, campaign_id, timestamp, inventory, relationships, ... }
- Campaign chunk (ingested): { content, embedding, sourceType, weightTier, fileOrigin, isPlayer, ... } per Section 6.1.1 Lore Chunk schema

Failure Modes
- Plan generation timeout during campaign load: Trigger replan loop (max 5 attempts), fallback to template narration
- Character realization failure (LLM timeout): Show retry dialog, allow return to character selection
- Corrupt campaign.yml: Show error message, return to campaign discovery
- Database initialization failure: Retry up to 3 times with exponential backoff

UI Pattern References
- Warning badges: Color-coded, tappable, display prominent in campaign detail view
- Back button state management: Preserve selection state when navigating back (unless explicitly cleared)
- Loading indicators: Show progress percentage for model downloads, spinner with status text for campaign ingestion
- Modal dialogs: Content warnings use modal with checkbox acknowledgment requirement if campaign mandates it
- Advisory notes: Informational banners for fresh character constraint status (non-blocking)

Testing Checkpoints
- All 11 UI states defined with clear entry/exit conditions
- 5 primary decision points have complete workflow documentation
- Alternative flows (Load Game, Options, Exit) documented with error cases
- State transitions verified against architecture constraints
- Character constraint advisory logic matches Section 6.2.6 contract
- Back button behavior consistent across all states
- Campaign loading includes YAML frontmatter extraction, character realization, and ObjectBox ingestion
- Frontmatter chunks stored with `sourceType: frontmatter` and `weightTier: 1`; prose chunks with `sourceType: prose` and `weightTier: 3` or `4` (Section 5.3.1)
- Realized player character chunks stored with `isPlayer: true` and `weightTier: 2`
- No-Shadow Rule enforced: no cross-file prose overrides of frontmatter assertions

Cross-References for Implementation
- Specification 008: UI Layer Implementation (to be created) should reference this journey
- States.md is authoritative for UI state machine structure
- Step definitions in steps.md map directly to implementation checkpoints
- Interactions.md defines accessibility and input handling requirements
